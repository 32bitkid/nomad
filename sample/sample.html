<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8" />
	<title></title>
	<link rel=stylesheet href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css">
	<link href="//netdna.bootstrapcdn.com/font-awesome/3.1.1/css/font-awesome.min.css" rel="stylesheet">
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.js"></script>
	<script src="//maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
	<script src="http://underscorejs.org/underscore-min.js"></script>
	<script src="http://backbonejs.org/backbone-min.js"></script>
	<script>
		Points = Backbone.Collection.extend({});

		Trails = Backbone.Collection.extend({
			url: "trails",
			createPointsCollection: function() {
				return Points.extend({
					url: this.get("points").href
				})
			}
		});

		NameView = Backbone.View.extend({
			initialize: function() {
				this.listenTo(this.collection, "activate", this.onActivate)
			},
			onActivate: function(trail) {
				this.$el.text(trail.get("name"))
				return this;
			}
		})

		DescriptionView = Backbone.View.extend({
			initialize: function() {
				this.listenTo(this.collection, "activate", this.onActivate)
			},
			onActivate: function(trail) {
				this.$el.text(trail.get("description"))
				return this;
			}
		});

		MapView = Backbone.View.extend({
			initialize: function() {
				//this.listenTo(this.collection, "all", function() { console.log(arguments); })
				this.listenTo(this.collection, "request", this.scrim)
				this.listenTo(this.collection, "sync", this.showLength)
				this.listenTo(this.collection, "sync", this.drawPath)
				this.listenTo(this.collection, "request", this.clearMap)

				var options = {
					zoom: 4,
					mapTypeId: google.maps.MapTypeId.TERRAIN
				}

				this.map = new google.maps.Map(this.$("#map-canvas").get(0), options)
			},
			render: function() {
				return this;
			},
			scrim: function() {
				this.$("#loading").show()
			},
			clearMap: function() {
				if(this.currentPolyline) {
					this.currentPolyline.setMap(null)
					this.currentPolyline = undefined
				}
			},
			drawPath: function() {
				this.$("#loading").hide()

				if(this.collection.length == 0) return;

				this.$el.removeClass("icon-spinner icon-4x")
				var points = this.collection.toJSON();
				var first = points[0], last = points[points.length - 1]
				var bounds = new google.maps.LatLngBounds(
					new google.maps.LatLng(
						Math.min(first.lat, last.lat),
						Math.min(first.long, last.long)
					),
					new google.maps.LatLng(
						Math.max(first.lat, last.lat),
						Math.max(first.long, last.long)
					)
				)
				var center = new google.maps.LatLng(
					0.5 * (first.lat + last.lat),
					0.5 * (first.long + last.long)
				)

				this.map.fitBounds(bounds)

				var polyline = {
					path: [],
					strokeColor: '#FF0000',
					strokeOpacity: 1.0,
					strokeWeight: 2
				}
				$.each(points, function (index, point) {
					polyline.path.push(new google.maps.LatLng(point.lat, point.long))
				})
				this.currentPolyline = new google.maps.Polyline(polyline)
				this.currentPolyline.setMap(this.map)
			},
			showLength: function () {
				if(this.collection.length == 0) {
					this.$('#totalLength').text("")
					return;
				}

				var first = this.collection.first().get("distanceFromStart"),
					last = this.collection.last().get("distanceFromStart")
				var text = 'Total length shown: ' + (last - first).toFixed(2) + ' kilometers'
				this.$('#totalLength').text(text)
			}
		})

		VisualizationView = Backbone.View.extend({
			initialize: function() {
				this.listenTo(this.collection, "request", this.clearStats)
				this.listenTo(this.collection, "sync", this.updateStats)
				this.canvas = this.$("#elevation canvas").get(0)
			},
			clearStats: function() {
				this.$("#start h3, #end h3").text("...")

				this.canvas.width = this.canvas.width

			},
			updateStats: function() {
				if(this.collection.length == 0) return;

				startKM = this.collection.first().get("distanceFromStart")
				endKM = this.collection.last().get("distanceFromStart")

				elevations = this.collection.pluck("elevation")
				minElevation = _.min(elevations)
				maxElevation = _.max(elevations)

				this.$("#start h3").text(startKM.toFixed(0) +"km")
				this.$("#end h3").text(endKM.toFixed(0) +"km")

				var width = this.canvas.width;
				var height = this.canvas.height;

				var ctx = this.canvas.getContext("2d")
				ctx.save()

				ctx.beginPath()
				ctx.moveTo(0,height)
				ctx.fillStyle = "#3498db"


				var eleToY = function(ele) {
					var elePercent = (ele - minElevation) / (maxElevation - minElevation)
					return  (height/2) - (elePercent - 0.5) * 75
				}

				var drawGuide = function(ctx, y) {
					ctx.beginPath()
					ctx.moveTo(0,y)
					ctx.lineTo(width,y)
					ctx.stroke()

				}

				this.collection.each(function(p) {
					var x = (p.get("distanceFromStart") - startKM) / (endKM - startKM) * width
					var y = eleToY(p.get("elevation"))
					ctx.lineTo(x,y)
				})

				ctx.lineTo(width,height)
				ctx.fill()

				ctx.save()
				ctx.lineWidth = 2
				ctx.globalAlpha = 0.25

				ctx.strokeStyle = "#2980b9"
				drawGuide(ctx, height/2)

				ctx.strokeStyle = "#f1c40f"
				drawGuide(ctx, eleToY(maxElevation))

				ctx.strokeStyle = "#c0392b"
				drawGuide(ctx, eleToY(minElevation))
				ctx.restore()

				ctx.restore()
			}
		})

		$(function () {
			var trails = new Trails();
			var points = window.points = new Backbone.Collection();

			var nameView = new NameView({collection: trails, el:document.getElementById("name")}).render();
			var descriptionView = new DescriptionView({collection: trails, el:document.getElementById("description")}).render()
			var mapView = new MapView({collection:points, el:document.getElementById("map")}).render()
			var vizView = new VisualizationView({collection:points, el:document.getElementById("visualization")}).render()

			trails.fetch().done(function() {
				var firstTrail = trails.first()
				firstTrail = firstTrail.trigger("activate", firstTrail)
				points.url = firstTrail.get("points").href
				points.fetch()
			})
		})
	</script>
	<style>
		#map-canvas {
			height: 300px;
			width: 100%;
			line-height: 60px;
		}
		#visualization {
			height: 200px;
			width: 100%;
			display: table;
		}

		#elevation, #start, #end { display: table-cell; }

		#elevation {		}

		#graph {
			width: 100%; height: 200px;
		}

		#start, #end {
			width: 7em;
			background-color: #ccc;
			text-align: center;
			vertical-align: middle;
		}

	</style>
</head>
<body>
	<h1 id="name"></h1>
	<div id="description"></div>
	<div id="visualization">
		<div id="start"><h3>...</h3></div>
		<div id="elevation"><canvas id="graph" width="800" height="200"></canvas></div>
		<div id="end"><h3>...</h3></div>
	</div>
	<div id="map">
		<div id="loading" class="icon-spinner icon-spin icon-4x"></div>
		<h3 id=totalLength></h3>
		<div id="map-canvas"></div>
	</div>
</body>
</html>